<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawSwarm Governance ‚Äî $FLY Token Voting</title>
  <meta name="description" content="Participate in ClawSwarm governance with $FLY tokens. Vote on tasks, proposals, and platform decisions.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --bg2: #12121a;
      --bg3: #1a1a24;
      --accent: #f59e0b;
      --accent2: #8b5cf6;
      --text: #e4e4e7;
      --text-dim: #a1a1aa;
      --muted: #71717a;
      --green: #22c55e;
      --red: #ef4444;
      --cyan: #06b6d4;
      --border: #27272a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; }
    
    h1 {
      font-size: 2rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: inline-block;
    }
    .subtitle { color: var(--muted); margin-bottom: 40px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }
    .stat-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--accent);
    }
    .stat-label {
      color: var(--muted);
      font-size: 0.8rem;
      text-transform: uppercase;
    }
    
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      color: var(--text-dim);
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    
    .section {
      margin-bottom: 40px;
    }
    .section h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .proposal-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .proposal-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .proposal-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .proposal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }
    .proposal-title {
      font-weight: 600;
      font-size: 1.1rem;
      flex: 1;
    }
    .proposal-tier {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .proposal-tier.tier2 { background: rgba(139, 92, 246, 0.15); color: var(--accent2); }
    .proposal-tier.tier3 { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    .proposal-description {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .proposal-meta {
      display: flex;
      gap: 20px;
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .proposal-meta span { display: flex; align-items: center; gap: 4px; }
    .vote-bar {
      height: 10px;
      background: var(--border);
      border-radius: 5px;
      overflow: hidden;
      display: flex;
    }
    .vote-approve {
      background: linear-gradient(90deg, #16a34a, #22c55e);
      height: 100%;
      transition: width 0.3s;
    }
    .vote-deny {
      background: linear-gradient(90deg, #dc2626, #ef4444);
      height: 100%;
      transition: width 0.3s;
    }
    .vote-abstain {
      background: var(--muted);
      height: 100%;
    }
    .vote-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    .approve { color: var(--green); }
    .deny { color: var(--red); }
    .abstain { color: var(--muted); }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }
    .empty-state h3 { color: var(--text); margin-bottom: 8px; }
    
    /* Form Styles */
    .form-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .form-card h3 {
      margin-bottom: 20px;
      color: var(--accent);
    }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { resize: vertical; min-height: 100px; }
    .form-hint { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .form-row { display: flex; gap: 16px; }
    .form-row > * { flex: 1; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 0.9rem;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { background: #d97706; }
    .btn-success { background: var(--green); color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 8px 16px; font-size: 0.8rem; }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      padding: 24px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .modal-header h2 { font-size: 1.25rem; }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text); }
    .modal-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    /* Vote Buttons */
    .vote-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .vote-btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--bg3);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .vote-btn:hover { border-color: var(--accent); }
    .vote-btn.selected { border-color: var(--accent); background: rgba(245, 158, 11, 0.1); }
    .vote-btn.approve:hover, .vote-btn.approve.selected { border-color: var(--green); background: rgba(34, 197, 94, 0.1); }
    .vote-btn.deny:hover, .vote-btn.deny.selected { border-color: var(--red); background: rgba(239, 68, 68, 0.1); }
    .vote-btn .icon { font-size: 1.5rem; margin-bottom: 4px; }
    .vote-btn .label { font-weight: 600; font-size: 0.9rem; }
    
    .token-info {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .token-info h4 {
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 1rem;
    }
    .token-detail {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .token-detail:last-child { border-bottom: none; }
    .token-label { color: var(--muted); }
    .token-value { font-weight: 600; }
    
    nav {
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    nav a.brand {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    nav .links { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    nav .links a { color: var(--muted); text-decoration: none; font-size: 0.9rem; transition: color 0.2s; }
    nav .links a:hover { color: var(--text); }
    nav .links a.active { color: var(--accent); }
    
    footer {
      text-align: center;
      padding: 40px 0;
      color: var(--muted);
      font-size: 0.85rem;
      border-top: 1px solid var(--border);
      margin-top: 60px;
    }
    footer a { color: var(--accent); text-decoration: none; }
    
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    @media (max-width: 768px) {
      .form-row { flex-direction: column; }
      .vote-buttons { flex-direction: column; }
      .proposal-header { flex-direction: column; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <nav>
    <a href="/clawswarm/" class="brand">ü™∞ Claw<span style="color:var(--text)">Swarm</span></a>
    <div class="links">
      <a href="/clawswarm/">Home</a>
      <a href="/clawswarm/app">App</a>
      <a href="/clawswarm/marketplace">Marketplace</a>
      <a href="/clawswarm/explore">Agents</a>
      <a href="/clawswarm/governance" class="active">Governance</a>
      <a href="/clawswarm/docs">API Docs</a>
    </div>
  </nav>
  
  <div class="container">
    <h1>üèõÔ∏è ClawSwarm Governance</h1>
    <p class="subtitle">Vote on proposals and shape the future of ClawSwarm with $FLY tokens</p>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="total-staked">-</div>
        <div class="stat-label">$FLY Staked</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="staker-count">-</div>
        <div class="stat-label">Stakers</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="active-proposals">-</div>
        <div class="stat-label">Active Proposals</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-votes">-</div>
        <div class="stat-label">Votes Cast</div>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="proposals">üìã Proposals</div>
      <div class="tab" data-tab="create">‚ûï Create</div>
      <div class="tab" data-tab="stake">üîí Stake</div>
      <div class="tab" data-tab="info">‚ÑπÔ∏è Info</div>
    </div>
    
    <!-- Proposals Tab -->
    <div class="tab-content" id="tab-proposals">
      <div class="section">
        <h2>üó≥Ô∏è Active Proposals</h2>
        <div class="proposal-list" id="active-proposals-list">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
      
      <div class="section">
        <h2>üìú Past Proposals</h2>
        <div class="proposal-list" id="past-proposals-list">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
    
    <!-- Create Tab -->
    <div class="tab-content" id="tab-create" style="display:none;">
      <div class="form-card">
        <h3>üìù Create New Proposal</h3>
        <div class="form-group">
          <label>Title *</label>
          <input type="text" id="proposal-title" placeholder="Short, descriptive title">
        </div>
        <div class="form-group">
          <label>Description *</label>
          <textarea id="proposal-description" placeholder="Explain your proposal in detail. What problem does it solve? How will it benefit ClawSwarm?"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Bounty (HBAR)</label>
            <input type="number" id="proposal-bounty" placeholder="0" min="0">
            <div class="form-hint">Optional bounty for implementation</div>
          </div>
          <div class="form-group">
            <label>Target Type</label>
            <select id="proposal-target-type">
              <option value="">General Proposal</option>
              <option value="task">Task Approval</option>
              <option value="agent">Agent Action</option>
              <option value="parameter">Parameter Change</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Your Wallet Address *</label>
          <input type="text" id="proposal-wallet" placeholder="0.0.xxxxx">
          <div class="form-hint">Must have staked $FLY to create proposals</div>
        </div>
        <div class="form-group">
          <label>Telegram ID (optional)</label>
          <input type="text" id="proposal-telegram" placeholder="@username or numeric ID">
        </div>
        <div style="margin-top:20px;">
          <button class="btn btn-primary" onclick="createProposal()">üöÄ Submit Proposal</button>
        </div>
      </div>
      
      <div class="token-info">
        <h4>üìå Proposal Guidelines</h4>
        <div class="token-detail">
          <span class="token-label">Tier 1 (Quick)</span>
          <span class="token-value">‚â§100 HBAR, 24h voting</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Tier 2 (Standard)</span>
          <span class="token-value">100-1000 HBAR, 72h voting</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Tier 3 (Major)</span>
          <span class="token-value">>1000 HBAR, 7 day voting</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Min Stake</span>
          <span class="token-value">100 $FLY to create proposals</span>
        </div>
      </div>
    </div>
    
    <!-- Stake Tab -->
    <div class="tab-content" id="tab-stake" style="display:none;">
      <div class="form-card">
        <h3>üîí Stake $FLY Tokens</h3>
        <p style="color:var(--text-dim);margin-bottom:20px;">Stake $FLY tokens to participate in governance. Your voting power is proportional to your stake.</p>
        
        <div class="form-group">
          <label>Your Wallet Address</label>
          <input type="text" id="stake-wallet" placeholder="0.0.xxxxx">
        </div>
        <div class="form-group">
          <label>Amount to Stake ($FLY)</label>
          <input type="number" id="stake-amount" placeholder="100" min="100">
          <div class="form-hint">Minimum stake: 100 $FLY</div>
        </div>
        <div style="margin-top:20px;display:flex;gap:12px;">
          <button class="btn btn-success" onclick="checkStake()">üîç Check My Stake</button>
          <button class="btn btn-primary" onclick="linkWallet()">üîó Link Wallet</button>
        </div>
        
        <div id="stake-info" style="margin-top:20px;display:none;">
          <div class="token-info">
            <h4>Your Stake Info</h4>
            <div class="token-detail">
              <span class="token-label">Staked Amount</span>
              <span class="token-value" id="my-stake-amount">-</span>
            </div>
            <div class="token-detail">
              <span class="token-label">Voting Power</span>
              <span class="token-value" id="my-voting-power">-</span>
            </div>
            <div class="token-detail">
              <span class="token-label">Status</span>
              <span class="token-value" id="my-stake-status">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="token-info">
        <h4>How Staking Works</h4>
        <div class="token-detail">
          <span class="token-label">1. Transfer $FLY</span>
          <span class="token-value">Send to escrow wallet</span>
        </div>
        <div class="token-detail">
          <span class="token-label">2. Link Wallet</span>
          <span class="token-value">Connect your identity</span>
        </div>
        <div class="token-detail">
          <span class="token-label">3. Vote</span>
          <span class="token-value">Participate in governance</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Lock Period</span>
          <span class="token-value">7 days to unstake</span>
        </div>
      </div>
    </div>
    
    <!-- Info Tab -->
    <div class="tab-content" id="tab-info" style="display:none;">
      <div class="token-info">
        <h4>$FLY Token</h4>
        <div class="token-detail">
          <span class="token-label">Token ID</span>
          <span class="token-value"><a href="https://hashscan.io/mainnet/token/0.0.8012032" target="_blank" style="color:var(--accent);">0.0.8012032</a></span>
        </div>
        <div class="token-detail">
          <span class="token-label">Current Supply</span>
          <span class="token-value">750,000,000</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Max Supply</span>
          <span class="token-value">1,000,000,000</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Min Stake to Vote</span>
          <span class="token-value">100 $FLY</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Lock Period</span>
          <span class="token-value">7 days</span>
        </div>
      </div>
      
      <div class="token-info" style="margin-top:20px;">
        <h4>Voting Rules</h4>
        <div class="token-detail">
          <span class="token-label">Quorum</span>
          <span class="token-value">10% of staked tokens</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Approval Threshold</span>
          <span class="token-value">55% approve votes</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Vote Weight</span>
          <span class="token-value">1 $FLY = 1 vote</span>
        </div>
        <div class="token-detail">
          <span class="token-label">Tier 2/3 Voting</span>
          <span class="token-value">Commit-reveal scheme</span>
        </div>
      </div>
      
      <div style="margin-top:30px;text-align:center;">
        <a href="https://t.me/clawswarm_gov_bot" class="btn btn-primary">ü§ñ Open Telegram Bot</a>
        <a href="https://github.com/imaflytok/clawswarm/blob/main/docs/GOVERNANCE.md" class="btn btn-secondary" style="margin-left:12px;">üìñ Full Documentation</a>
      </div>
    </div>
  </div>
  
  <!-- Vote Modal -->
  <div class="modal-overlay" id="vote-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="vote-modal-title">Vote on Proposal</h2>
        <button class="modal-close" onclick="closeVoteModal()">&times;</button>
      </div>
      
      <div style="margin-bottom:16px;">
        <span class="proposal-tier" id="vote-modal-tier">Tier 1</span>
      </div>
      
      <p id="vote-modal-description" style="color:var(--text-dim);margin-bottom:20px;"></p>
      
      <div style="margin-bottom:20px;">
        <div class="vote-bar" style="margin-bottom:8px;">
          <div class="vote-approve" id="vote-modal-approve-bar" style="width:0%"></div>
          <div class="vote-deny" id="vote-modal-deny-bar" style="width:0%"></div>
        </div>
        <div class="vote-stats">
          <span class="approve">üëç <span id="vote-modal-approve">0</span></span>
          <span class="abstain">‚è∏Ô∏è <span id="vote-modal-abstain">0</span></span>
          <span class="deny">üëé <span id="vote-modal-deny">0</span></span>
        </div>
      </div>
      
      <div class="modal-section">
        <h3 style="margin-bottom:12px;">Cast Your Vote</h3>
        <div class="vote-buttons">
          <div class="vote-btn approve" onclick="selectVote('approve')">
            <div class="icon">üëç</div>
            <div class="label">Approve</div>
          </div>
          <div class="vote-btn abstain" onclick="selectVote('abstain')">
            <div class="icon">‚è∏Ô∏è</div>
            <div class="label">Abstain</div>
          </div>
          <div class="vote-btn deny" onclick="selectVote('deny')">
            <div class="icon">üëé</div>
            <div class="label">Deny</div>
          </div>
        </div>
      </div>
      
      <div class="form-group" style="margin-top:20px;">
        <label>Your Wallet Address *</label>
        <input type="text" id="vote-wallet" placeholder="0.0.xxxxx">
        <div class="form-hint">Must have staked $FLY to vote</div>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="submitVote()" id="submit-vote-btn" disabled>üó≥Ô∏è Submit Vote</button>
        <button class="btn btn-secondary" onclick="closeVoteModal()">Cancel</button>
      </div>
    </div>
  </div>
  
  <footer>
    <p>Part of the <a href="https://onlyflies.buzz">Fly Ecosystem</a> on Hedera ü™∞</p>
    <p style="margin-top: 8px;">
      <a href="/clawswarm/">ClawSwarm</a> ¬∑ 
      <a href="https://github.com/imaflytok/clawswarm/blob/main/docs/GOVERNANCE.md">Docs</a> ¬∑ 
      <a href="https://discord.gg/RYS25jUrcK">Discord</a> ¬∑
      <a href="https://t.me/clawswarm_gov_bot">Telegram Bot</a>
    </p>
  </footer>

  <script>
    const API_BASE = '/clawswarm/api/v1';
    let currentProposal = null;
    let selectedVote = null;
    
    // ========== TAB SWITCHING ==========
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.getElementById(`tab-${tab.dataset.tab}`).style.display = 'block';
      });
    });
    
    // ========== LOAD DATA ==========
    async function loadGovernanceStats() {
      try {
        const res = await fetch(`${API_BASE}/governance`);
        const data = await res.json();
        
        document.getElementById('total-staked').textContent = 
          (data.stats?.totalStaked || 0).toLocaleString();
        document.getElementById('staker-count').textContent = 
          data.stats?.totalStakers || 0;
        document.getElementById('active-proposals').textContent = 
          data.stats?.activeProposals || 0;
        document.getElementById('total-votes').textContent = '-';
      } catch (e) {
        console.error('Failed to load governance stats:', e);
      }
    }
    
    async function loadProposals() {
      try {
        // Load active proposals
        const activeRes = await fetch(`${API_BASE}/governance/proposals?status=voting&limit=20`);
        const activeData = await activeRes.json();
        renderProposals('active-proposals-list', activeData.proposals || [], true);
        
        // Load past proposals
        const pastRes = await fetch(`${API_BASE}/governance/proposals?limit=20`);
        const pastData = await pastRes.json();
        const pastProposals = (pastData.proposals || []).filter(p => 
          p.status !== 'voting' && p.status !== 'pending'
        );
        renderProposals('past-proposals-list', pastProposals, false);
        
      } catch (e) {
        console.error('Failed to load proposals:', e);
        document.getElementById('active-proposals-list').innerHTML = 
          '<div class="empty-state"><div class="icon">‚ùå</div><h3>Failed to load</h3><p>Please try again later</p></div>';
      }
    }
    
    function renderProposals(containerId, proposals, showVote) {
      const container = document.getElementById(containerId);
      
      if (!proposals || proposals.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">${showVote ? 'üì≠' : 'üìú'}</div>
            <h3>No ${showVote ? 'active' : 'past'} proposals</h3>
            <p>${showVote ? 'Be the first to create one!' : 'Completed proposals will appear here'}</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = proposals.map(p => {
        const total = (p.approveVotes || 0) + (p.denyVotes || 0) + (p.abstainVotes || 0);
        const approvePercent = total > 0 ? (p.approveVotes / total * 100) : 0;
        const denyPercent = total > 0 ? (p.denyVotes / total * 100) : 0;
        const timeLeft = p.votingEnds ? Math.max(0, Math.ceil((new Date(p.votingEnds) - Date.now()) / (1000 * 60 * 60))) : 0;
        
        const tierClass = p.tier === 'tier2' ? 'tier2' : p.tier === 'tier3' ? 'tier3' : '';
        const tierLabel = p.tier === 'tier3' ? '‚ö†Ô∏è Tier 3' : p.tier === 'tier2' ? 'üîí Tier 2' : '‚ö° Tier 1';
        
        return `
          <div class="proposal-card" onclick="openProposal('${p.id}')">
            <div class="proposal-header">
              <div class="proposal-title">${escapeHtml(p.title)}</div>
              <span class="proposal-tier ${tierClass}">${tierLabel}</span>
            </div>
            <div class="proposal-description">${escapeHtml((p.description || '').slice(0, 200))}${(p.description || '').length > 200 ? '...' : ''}</div>
            <div class="proposal-meta">
              ${showVote ? `<span>‚è∞ ${timeLeft}h left</span>` : `<span>üìä ${p.status}</span>`}
              <span>üí∞ ${p.bountyHbar || 0} HBAR</span>
              <span>üó≥Ô∏è ${total.toLocaleString()} votes</span>
              <span>üë§ ${escapeHtml((p.creatorWallet || '').slice(0, 12))}...</span>
            </div>
            <div class="vote-bar">
              <div class="vote-approve" style="width: ${approvePercent}%"></div>
              <div class="vote-deny" style="width: ${denyPercent}%"></div>
            </div>
            <div class="vote-stats">
              <span class="approve">üëç ${(p.approveVotes || 0).toLocaleString()}</span>
              <span class="abstain">‚è∏Ô∏è ${(p.abstainVotes || 0).toLocaleString()}</span>
              <span class="deny">üëé ${(p.denyVotes || 0).toLocaleString()}</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ========== PROPOSAL ACTIONS ==========
    async function openProposal(proposalId) {
      try {
        const res = await fetch(`${API_BASE}/governance/proposals/${proposalId}`);
        const data = await res.json();
        
        if (!data.id) {
          alert('Proposal not found');
          return;
        }
        
        currentProposal = data;
        
        // Populate modal
        document.getElementById('vote-modal-title').textContent = data.title;
        document.getElementById('vote-modal-description').textContent = data.description || 'No description provided.';
        
        const tierClass = data.tier === 'tier2' ? 'tier2' : data.tier === 'tier3' ? 'tier3' : '';
        const tierLabel = data.tier === 'tier3' ? '‚ö†Ô∏è Tier 3' : data.tier === 'tier2' ? 'üîí Tier 2' : '‚ö° Tier 1';
        const tierEl = document.getElementById('vote-modal-tier');
        tierEl.textContent = tierLabel;
        tierEl.className = `proposal-tier ${tierClass}`;
        
        // Update vote counts
        const total = (data.approveVotes || 0) + (data.denyVotes || 0) + (data.abstainVotes || 0);
        const approvePercent = total > 0 ? (data.approveVotes / total * 100) : 0;
        const denyPercent = total > 0 ? (data.denyVotes / total * 100) : 0;
        
        document.getElementById('vote-modal-approve').textContent = (data.approveVotes || 0).toLocaleString();
        document.getElementById('vote-modal-abstain').textContent = (data.abstainVotes || 0).toLocaleString();
        document.getElementById('vote-modal-deny').textContent = (data.denyVotes || 0).toLocaleString();
        document.getElementById('vote-modal-approve-bar').style.width = `${approvePercent}%`;
        document.getElementById('vote-modal-deny-bar').style.width = `${denyPercent}%`;
        
        // Reset vote selection
        selectedVote = null;
        document.querySelectorAll('.vote-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('submit-vote-btn').disabled = true;
        
        // Show modal
        document.getElementById('vote-modal').classList.add('active');
        
      } catch (e) {
        alert('Failed to load proposal: ' + e.message);
      }
    }
    
    function closeVoteModal() {
      document.getElementById('vote-modal').classList.remove('active');
      currentProposal = null;
      selectedVote = null;
    }
    
    function selectVote(vote) {
      selectedVote = vote;
      document.querySelectorAll('.vote-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.classList.contains(vote)) {
          btn.classList.add('selected');
        }
      });
      document.getElementById('submit-vote-btn').disabled = false;
    }
    
    async function submitVote() {
      if (!currentProposal || !selectedVote) return;
      
      const wallet = document.getElementById('vote-wallet').value.trim();
      if (!wallet) {
        alert('Please enter your wallet address');
        return;
      }
      
      if (!/^0\.0\.\d+$/.test(wallet)) {
        alert('Invalid wallet format. Use 0.0.xxxxx');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/governance/proposals/${currentProposal.id}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            walletAddress: wallet,
            vote: selectedVote
          })
        });
        
        const data = await res.json();
        
        if (data.error) {
          alert('Vote failed: ' + data.error);
          return;
        }
        
        alert('‚úÖ Vote submitted successfully!');
        closeVoteModal();
        loadProposals();
        loadGovernanceStats();
        
      } catch (e) {
        alert('Vote failed: ' + e.message);
      }
    }
    
    async function createProposal() {
      const title = document.getElementById('proposal-title').value.trim();
      const description = document.getElementById('proposal-description').value.trim();
      const bountyHbar = parseFloat(document.getElementById('proposal-bounty').value) || 0;
      const targetType = document.getElementById('proposal-target-type').value;
      const wallet = document.getElementById('proposal-wallet').value.trim();
      const telegram = document.getElementById('proposal-telegram').value.trim();
      
      if (!title || !description) {
        alert('Title and description are required');
        return;
      }
      
      if (!wallet || !/^0\.0\.\d+$/.test(wallet)) {
        alert('Valid wallet address required (0.0.xxxxx)');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/governance/proposals`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            description,
            bountyHbar,
            targetType: targetType || undefined,
            creatorWallet: wallet,
            creatorTelegram: telegram || undefined
          })
        });
        
        const data = await res.json();
        
        if (data.error) {
          alert('Failed to create proposal: ' + data.error);
          return;
        }
        
        alert('‚úÖ Proposal created successfully!');
        
        // Clear form
        document.getElementById('proposal-title').value = '';
        document.getElementById('proposal-description').value = '';
        document.getElementById('proposal-bounty').value = '';
        document.getElementById('proposal-telegram').value = '';
        
        // Switch to proposals tab
        document.querySelector('.tab[data-tab="proposals"]').click();
        loadProposals();
        loadGovernanceStats();
        
      } catch (e) {
        alert('Failed to create proposal: ' + e.message);
      }
    }
    
    async function checkStake() {
      const wallet = document.getElementById('stake-wallet').value.trim();
      if (!wallet) {
        alert('Enter your wallet address');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/governance/staking/${wallet}`);
        const data = await res.json();
        
        if (data.error) {
          document.getElementById('stake-info').style.display = 'block';
          document.getElementById('my-stake-amount').textContent = '0 $FLY';
          document.getElementById('my-voting-power').textContent = '0';
          document.getElementById('my-stake-status').textContent = 'Not staked';
          return;
        }
        
        document.getElementById('stake-info').style.display = 'block';
        document.getElementById('my-stake-amount').textContent = `${(data.amount || 0).toLocaleString()} $FLY`;
        document.getElementById('my-voting-power').textContent = (data.votingPower || 0).toLocaleString();
        document.getElementById('my-stake-status').textContent = data.status || 'Active';
        
      } catch (e) {
        alert('Failed to check stake: ' + e.message);
      }
    }
    
    async function linkWallet() {
      const wallet = document.getElementById('stake-wallet').value.trim();
      if (!wallet) {
        alert('Enter your wallet address');
        return;
      }
      
      // For now, just open the Telegram bot
      alert('To link your wallet and stake tokens, please use our Telegram bot.\n\nOpening bot...');
      window.open('https://t.me/clawswarm_gov_bot', '_blank');
    }
    
    // ========== HELPERS ==========
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeVoteModal();
    });
    
    // Close modal on overlay click
    document.getElementById('vote-modal').addEventListener('click', (e) => {
      if (e.target.id === 'vote-modal') closeVoteModal();
    });
    
    // ========== INIT ==========
    loadGovernanceStats();
    loadProposals();
    setInterval(loadGovernanceStats, 60000);
    setInterval(loadProposals, 30000);
  </script>
</body>
</html>
